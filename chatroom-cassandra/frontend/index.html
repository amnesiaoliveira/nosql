<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chat-APX</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="chat-layout">
    <div id="roomsSidebar">
      <div class="p-3 border-bottom border-secondary"><h5 class="mb-0 text-primary"><i class="bi bi-chat-dots-fill"></i> Salas</h5></div>
      <div id="roomsList" class="text-center text-muted p-4"><i class="bi bi-hourglass-split display-4"></i><p>Carregando salas...</p></div>
    </div>

    <div id="chatCenter">
      <div class="chat-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-hash"></i> <span id="currentRoom">carregando...</span></span>
        <button class="btn btn-sm btn-outline-light" onclick="location.reload()"><i class="bi bi-arrow-repeat"></i> Trocar</button>
      </div>
      <div id="messages"></div>
      <div id="previewContainer" style="display:none;">
        <img id="imagePreview" src="" alt="Preview">
        <button class="remove-preview" onclick="clearPreview()">×</button>
      </div>
      <div class="chat-footer">
        <div class="input-group">
          <input type="text" id="msgInput" class="form-control bg-dark text-white border-secondary" placeholder="Digite sua mensagem...">
          <input type="file" id="fileInput" accept="image/*,audio/*,video/*" style="display:none">
          <button class="btn btn-outline-info" onclick="document.getElementById('fileInput').click()"><i class="bi bi-paperclip"></i></button>
          <button class="btn btn-primary" onclick="send()"><i class="bi bi-send"></i></button>
        </div>
      </div>
    </div>

    <div id="usersSidebar">
      <div class="p-3 border-bottom border-secondary"><h6 class="mb-0"><i class="bi bi-people-fill text-success"></i> Online <span id="onlineCount">0</span></h6></div>
      <div id="usersList"><div class="text-center text-muted p-4"><i class="bi bi-person-slash display-4"></i><p>Ninguém online</p></div></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let pendingFile = null;
    let currentRoomId = null;
    let currentRoomName = null;
    let username = null;

    const urlParams = new URLSearchParams(window.location.search);
    let urlRoom = urlParams.get('room');
    let urlUser = urlParams.get('user');

    if (!urlRoom) {
      currentRoomName = prompt("Nome da sala:", "geral") || "geral";
      username = urlUser || prompt("Seu nome:", "Usuário") || "Anônimo";
      history.replaceState(null, null, `?room=${encodeURIComponent(currentRoomName)}&user=${encodeURIComponent(username)}`);
    } else {
      currentRoomName = decodeURIComponent(urlRoom);
      username = urlUser || "Anônimo";
    }
    document.getElementById('currentRoom').textContent = currentRoomName;

    function renderRoomsList(rooms) {
      const list = document.getElementById('roomsList');
      list.innerHTML = '';
      rooms.forEach(r => {
        const div = document.createElement('div');
        div.className = 'room-item';
        if (r.room_id === currentRoomId) div.classList.add('active');
        div.innerHTML = `<i class="bi bi-hash"></i> ${r.room_name}`;
        div.onclick = () => changeRoom(r.room_id, r.room_name);
        list.appendChild(div);
      });
    }
    socket.on('rooms_list', renderRoomsList);

    function changeRoom(id, name) {
      if (id === currentRoomId) return;
      currentRoomId = id;
      currentRoomName = name;
      document.getElementById('currentRoom').textContent = name;
      document.getElementById('messages').innerHTML = '<p class="text-center text-muted">Carregando mensagens...</p>';
      window.history.replaceState(null, null, `?room=${encodeURIComponent(name)}&user=${encodeURIComponent(username)}`);
      socket.emit('join_room', { room_id: name, username });
    }

    socket.emit('join_room', { room_id: currentRoomName, username });

    socket.on('load_history', msgs => {
      document.getElementById('messages').innerHTML = '';
      if (msgs.length === 0) document.getElementById('messages').innerHTML = '<p class="text-center text-muted">Nenhuma mensagem ainda. Comece o papo!</p>';
      msgs.forEach(displayMessage);
      scrollToBottom();
    });

    socket.on('receive_message', msg => { displayMessage(msg); scrollToBottom(); });

    function scrollToBottom() {
      const el = document.getElementById('messages');
      el.scrollTop = el.scrollHeight;
    }

    function displayMessage(msg) {
      const div = document.createElement('div');
      div.className = `msg ${msg.sender_id === socket.id ? 'mine' : 'other'}`;
      const name = msg.sender_name || 'Anônimo';

      if (msg.message_type === 'text') {
        div.innerHTML = `<strong>${name}:</strong> ${msg.content_text || ''}`;
      } else if (msg.content_data && msg.content_data.data) {
        const uint8 = new Uint8Array(msg.content_data.data);
        const blob = new Blob([uint8], { type: msg.file_format || 'application/octet-stream' });
        const url = URL.createObjectURL(blob);

        if (msg.message_type === 'image')
          div.innerHTML = `<strong>${name}:</strong><br><img src="${url}" loading="lazy" class="img-fluid rounded" style="max-height:400px;">`;
        else if (msg.message_type === 'audio')
          div.innerHTML = `<strong>${name}:</strong><br><audio controls src="${url}" class="w-100"></audio>`;
        else if (msg.message_type === 'video')
          div.innerHTML = `<strong>${name}:</strong><br><video controls src="${url}" class="w-100 rounded" style="max-height:500px;"></video>`;
        else {
          const mb = (msg.file_size / 1024 / 1024).toFixed(2);
          div.innerHTML = `<strong>${name}:</strong><br><a href="${url}" download class="btn btn-sm btn-outline-light">Download (${mb} MB)</a>`;
        }
      }
      document.getElementById('messages').appendChild(div);
    }

    socket.on('users_in_room', users => {
      const list = document.getElementById('usersList');
      const count = document.getElementById('onlineCount');
      list.innerHTML = '';
      count.textContent = users.length;
      if (users.length === 0) {
        list.innerHTML = '<div class="text-center text-muted p-4"><p>Ninguém online</p></div>';
        return;
      }
      users.forEach(u => {
        const d = document.createElement('div');
        d.className = 'user-online';
        d.innerHTML = `<div class="status-dot"></div>${u.username}`;
        list.appendChild(d);
      });
    });

    document.getElementById('fileInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      pendingFile = file;
      if (file.type.startsWith('image/')) {
        const r = new FileReader();
        r.onload = ev => {
          document.getElementById('imagePreview').src = ev.target.result;
          document.getElementById('previewContainer').style.display = 'block';
        };
        r.readAsDataURL(file);
      } else {
        alert(`Arquivo: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`);
      }
    });

    function clearPreview() {
      document.getElementById('previewContainer').style.display = 'none';
      document.getElementById('imagePreview').src = '';
      document.getElementById('fileInput').value = '';
      pendingFile = null;
    }

    function send() {
      const input = document.getElementById('msgInput');
      if (pendingFile) {
        const file = pendingFile;
        const reader = new FileReader();
        reader.onload = e => {
          const uint8 = new Uint8Array(e.target.result);
          socket.emit('send_message', {
            message_type: file.type.startsWith('image/') ? 'image' :
                         file.type.startsWith('audio/') ? 'audio' :
                         file.type.startsWith('video/') ? 'video' : 'file',
            content_data: { data: Array.from(uint8) },
            content_text: null,
            file_format: file.type,
            file_size: file.size
          });
          clearPreview();
          input.value = '';
        };
        reader.readAsArrayBuffer(file);
      } else if (input.value.trim()) {
        socket.emit('send_message', {
          message_type: 'text',
          content_text: input.value.trim(),
          content_data: null
        });
        input.value = '';
      }
    }

    document.getElementById('msgInput').addEventListener('keypress', e => { if (e.key === 'Enter') send(); });
    socket.emit('request_rooms_list');
  </script>
</body>
</html>