<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ChatRoom - Cassandra + Preview (FUNCIONANDO 100%)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #111; color: #eee; }
    #messages { height: 65vh; overflow-y: auto; background: #222; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
    .msg { margin: 10px 0; padding: 12px; border-radius: 15px; max-width: 80%; word-wrap: break-word; }
    .mine { background: #0d6efd; color: white; margin-left: auto; }
    .other { background: #444; color: #ddd; }
    img, video { max-width: 100%; border-radius: 10px; margin-top: 8px; }
    audio { width: 100%; margin-top: 8px; }
    #previewContainer { position: relative; display: inline-block; margin: 10px auto; }
    #imagePreview { max-width: 250px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); }
    .remove-preview { position: absolute; top: -10px; right: -10px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 18px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="text-center mb-4 text-primary">Chat-APX</h1>
    
    <div class="card bg-dark border-secondary">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Sala: <strong id="currentRoom" class="text-info">carregando...</strong></span>
        <button class="btn btn-sm btn-outline-warning" onclick="location.reload()">Trocar Sala</button>
      </div>
      
      <div id="messages" class="card-body"></div>
      
      <!-- Preview da imagem -->
      <div id="previewContainer" class="text-center" style="display:none;">
        <img id="imagePreview" src="" alt="Pré-visualização">
        <button class="remove-preview" onclick="clearPreview()">×</button>
      </div>

      <div class="card-footer">
        <div class="input-group">
          <input type="text" id="msgInput" class="form-control bg-dark text-white border-secondary" placeholder="Digite sua mensagem...">
          <input type="file" id="fileInput" accept="image/*,audio/*,video/*" style="display:none">
          <button class="btn btn-primary" onclick="send()">Enviar</button>
          <button class="btn btn-info" onclick="document.getElementById('fileInput').click()">Arquivo</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let pendingFile = null;

    const urlParams = new URLSearchParams(window.location.search);
    const room_id = urlParams.get('room') || prompt("Nome da sala:", "geral") || "geral";
    const username = urlParams.get('user') || prompt("Seu nome:", "Usuário") || "Anônimo";

    document.getElementById('currentRoom').textContent = room_id;

    socket.emit('join_room', { room_id, user_id: Date.now().toString(), username });

    socket.on('load_history', msgs => {
      document.getElementById('messages').innerHTML = '';
      if (msgs.length === 0) {
        document.getElementById('messages').innerHTML = '<p class="text-center text-muted">Nenhuma mensagem ainda. Comece o papo!</p>';
      }
      msgs.forEach(msg => displayMessage(msg));
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    });

    // CORREÇÃO PRINCIPAL AQUI: aceita tanto Buffer quanto ArrayBuffer
    socket.on('receive_message', rawMsg => {
      let msg = { ...rawMsg };

      // Normaliza content_data (pode vir como {data: [...]}, Buffer ou ArrayBuffer)
      if (msg.content_data) {
        if (msg.content_data.data && Array.isArray(msg.content_data.data)) {
          msg.content_data = new Uint8Array(msg.content_data.data);
        } else if (msg.content_data instanceof ArrayBuffer) {
          msg.content_data = new Uint8Array(msg.content_data);
        }
      }

      displayMessage(msg);
    });

    // Preview ao selecionar imagem
    document.getElementById('fileInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      pendingFile = file;

      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = ev => {
          document.getElementById('imagePreview').src = ev.target.result;
          document.getElementById('previewContainer').style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        alert(`Arquivo selecionado: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`);
      }
    });

    function clearPreview() {
      document.getElementById('previewContainer').style.display = 'none';
      document.getElementById('imagePreview').src = '';
      document.getElementById('fileInput').value = '';
      pendingFile = null;
    }

    function displayMessage(msg) {
      const div = document.createElement('div');
      div.className = `msg ${msg.sender_id === socket.id ? 'mine' : 'other'}`;
      const name = msg.sender_name || username || 'Anônimo';

      if (msg.message_type === 'text') {
        div.innerHTML = `<strong>${name}:</strong> ${msg.content_text || ''}`;
      } else {
        // Garante que content_data seja Uint8Array
        const data = msg.content_data instanceof Uint8Array ? msg.content_data : new Uint8Array();
        const blob = new Blob([data], { type: msg.file_format || 'application/octet-stream' });
        const url = URL.createObjectURL(blob);

        if (msg.message_type === 'image') {
          div.innerHTML = `<strong>${name}:</strong><br>
            <img src="${url}" alt="Imagem" loading="lazy">`;
        } else if (msg.message_type === 'audio') {
          div.innerHTML = `<strong>${name}:</strong><br>
            <audio controls src="${url}"></audio>`;
        } else if (msg.message_type === 'video') {
          div.innerHTML = `<strong>${name}:</strong><br>
            <video controls src="${url}" playsinline></video>`;
        } else {
          const ext = msg.file_format?.split('/')[1] || 'file';
          const sizeMB = (msg.file_size / 1024 / 1024).toFixed(2);
          div.innerHTML = `<strong>${name}:</strong><br>
            <a href="${url}" download="arquivo_${Date.now()}.${ext}" class="btn btn-sm btn-outline-light">
              Arquivo (${sizeMB} MB)
            </a>`;
        }
      }

      document.getElementById('messages').appendChild(div);
      div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function send() {
      const input = document.getElementById('msgInput');

      if (pendingFile) {
        const file = pendingFile;
        const reader = new FileReader();
        reader.onload = e => {
          socket.emit('send_message', {
            room_id,
            sender_id: socket.id,
            sender_name: username,
            message_type: file.type.startsWith('image/') ? 'image' :
                         file.type.startsWith('audio/') ? 'audio' :
                         file.type.startsWith('video/') ? 'video' : 'file',
            content_data: e.target.result,
            file_format: file.type,
            file_size: file.size
          });
          clearPreview();
        };
        reader.readAsArrayBuffer(file);
      } else if (input.value.trim()) {
        socket.emit('send_message', {
          room_id,
          sender_id: socket.id,
          sender_name: username,
          message_type: 'text',
          content_text: input.value.trim()
        });
        input.value = '';
      }
    }

    document.getElementById('msgInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') send();
    });
  </script>
</body>
</html>